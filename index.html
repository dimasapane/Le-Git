<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Le-Git</title>
    <link rel="stylesheet" href="styles/style.css">
  </head>
  <body>
    <button id="dark-mode-toggle">Toggle Dark Mode</button>

    <h1>Welcome to Le-Git</h1>
    <h2>Your lecture tracker starts here!</h2>

    <form id="create-node-form">
      <input type="text" id="node-name" placeholder="Node Name" required>
      <select id="node-type">
        <option value="playlist">Playlist</option>
        <option value="custom">Custom Group</option>
      </select>
      <button type="submit">Create Node</button>
    </form>

    <div id="capture-video">
      <button id="capture-btn">Capture Current Video</button>
    </div>
    <div id="capture-form" style="display:none; gap:5px; margin-top:5px;">
      <input type="text" id="capture-url" placeholder="YouTube URL">
      <input type="text" id="capture-ts" placeholder="Timestamp mm:ss">
      <button id="capture-save-btn">Save</button>
    </div>

    <div id="quick-mark">
      <input type="number" id="mark-up-to" placeholder="Mark up to video #" min="1">
      <button id="mark-btn">Mark Videos</button>
    </div>

    <div id="nodes-container"></div>

    <script>
      const { ipcRenderer } = require('electron');

      // Dark mode
      const toggleBtn = document.getElementById('dark-mode-toggle');
      toggleBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
      });

      // Create node
      const form = document.getElementById('create-node-form');
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('node-name').value;
        const type = document.getElementById('node-type').value;
        ipcRenderer.send('create-node', { name, type });
        form.reset();
      });

      // Quick mark
      const markBtn = document.getElementById('mark-btn');
      markBtn.addEventListener('click', () => {
        const upTo = parseInt(document.getElementById('mark-up-to').value);
        if (!upTo || upTo < 1) return;
        ipcRenderer.send('mark-up-to', { upTo });
      });

      // Capture video
      const captureBtn = document.getElementById('capture-btn');
      const captureForm = document.getElementById('capture-form');
      const captureUrl = document.getElementById('capture-url');
      const captureTs = document.getElementById('capture-ts');
      const captureSaveBtn = document.getElementById('capture-save-btn');

      captureBtn.addEventListener('click', () => {
        captureForm.style.display = captureForm.style.display === 'none' ? 'flex' : 'none';
      });

      captureSaveBtn.addEventListener('click', () => {
        const url = captureUrl.value.trim();
        const ts = captureTs.value.trim() || '00:00';
        if(!url) return;
        ipcRenderer.send('capture-video-ui', { url, ts });
        captureUrl.value = '';
        captureTs.value = '';
        captureForm.style.display = 'none';
      });

      // Load nodes
      ipcRenderer.on('load-nodes', (event, nodes) => {
        const container = document.getElementById('nodes-container');
        container.innerHTML = '';
        nodes.forEach(node => {
          const div = document.createElement('div');
          div.classList.add('node');
          div.innerHTML = `
            <span>${node.name} - Progress: ${node.progress}%</span>
            <input type="checkbox" data-id="${node.id}" ${node.progress === 100 ? 'checked' : ''}>
            <textarea data-id="${node.id}" placeholder="Add notes...">${node.notes || ''}</textarea>
            <button class="delete-btn" data-id="${node.id}">Delete</button>
            <button class="continue-btn" data-id="${node.id}">Continue</button>
            <button class="up-btn" data-id="${node.id}">↑</button>
            <button class="down-btn" data-id="${node.id}">↓</button>
            <div class="custom-videos" data-id="${node.id}">
              <input type="text" placeholder="Add video URL">
              <input type="text" placeholder="Timestamp mm:ss">
              <button class="add-video-btn" data-id="${node.id}">Add</button>
              <ul class="video-list"></ul>
            </div>
          `;

          div.querySelector('input[type="checkbox"]').addEventListener('change', e => {
            const id = e.target.getAttribute('data-id');
            const progress = e.target.checked ? 100 : 0;
            ipcRenderer.send('update-progress', { id, progress });
          });

          div.querySelector('textarea').addEventListener('blur', e => {
            const id = e.target.getAttribute('data-id');
            ipcRenderer.send('save-notes', { id, notes: e.target.value });
          });

          div.querySelector('.delete-btn').addEventListener('click', e => {
            ipcRenderer.send('delete-node', { id: e.target.getAttribute('data-id') });
          });

          div.querySelector('.continue-btn').addEventListener('click', e => {
            ipcRenderer.send('continue-node', { id: e.target.getAttribute('data-id') });
          });

          div.querySelector('.up-btn').addEventListener('click', e => {
            ipcRenderer.send('move-node', { id: parseInt(e.target.getAttribute('data-id')), direction: 'up' });
          });

          div.querySelector('.down-btn').addEventListener('click', e => {
            ipcRenderer.send('move-node', { id: parseInt(e.target.getAttribute('data-id')), direction: 'down' });
          });
          div.querySelector('.add-video-btn').addEventListener('click', e => {
            const id = e.target.getAttribute('data-id');
            const container = e.target.parentElement;
            const url = container.querySelector('input:nth-child(1)').value.trim();
            const ts = container.querySelector('input:nth-child(2)').value.trim() || '00:00';
            if(!url) return;
            ipcRenderer.send('add-video-to-node', { id, url, ts });
          });

          if(node.type === 'custom'){
            ipcRenderer.invoke('get-videos', node.id).then(videos => {
              const ul = div.querySelector('.video-list');
              ul.innerHTML = '';
              videos.forEach(v => {
                const li = document.createElement('li');
                li.innerHTML = `${v.url} (${v.timestamp}) <button class="continue-video-btn" data-url="${v.url}" data-ts="${v.timestamp}">Continue</button>`;
                ul.appendChild(li);
                li.querySelector('.continue-video-btn').addEventListener('click', e => {
                  const url = e.target.getAttribute('data-url');
                  const ts = e.target.getAttribute('data-ts');
                  ipcRenderer.send('continue-video', { url, ts });
                });
              });
            });
          }

          container.appendChild(div);
        });
      });
    </script>
  </body>
</html>
